<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<title>Комната чата {{ chat_name }}</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
	<div class="container mt-5">
		<h1 class="text-center mb-4">Диалог: {{ chat_name }}</h1>
		<div id="chat-container" class="card p-4 mb-4">
			<div id="messages" class="mb-3"></div>
			<div class="input-group">
				<input type="text" id="message-input" class="form-control" placeholder="Напишите что-нибудь...">
				<button id="send-button" class="btn btn-primary">Отправить</button>
			</div>
		</div>
		<div class="text-center">
			<button id="delete-chat-button" class="btn btn-danger">Удалить диалог</button>
			<button id="back-button" class="btn btn-secondary">Назад</button>
		</div>
	</div>

	<script>
		// Переменные чата
		const chatName = "{{ chat_name }}";
		const user = "{{ user }}";
		const token = "{{ token }}";
		const ws = new WebSocket(`ws://${location.host}/ws/${chatName}?token=${token}`);

		// Открытие соединения
		ws.onopen = function () {
			console.log('Соединение установлено.');
		};

		// Получение сообщений
		ws.onmessage = function (event) {
			const messages = document.getElementById('messages');
			const message = document.createElement('p');
			message.textContent = event.data;
			messages.appendChild(message);
		};

		// Закрытие соединения
		ws.onclose = function () {
			console.log('Соединение закрыто.');
		};

		// Отправка сообщения
		document.getElementById('send-button').onclick = function () {
			const input = document.getElementById('message-input');
			ws.send(input.value);
			input.value = '';
		};

		// Удаление диалога
		document.getElementById('delete-chat-button').onclick = function () {
			if (confirm('Вы уверены, что хотите удалить этот диалог?')) {
				fetch(`/delete_chat/${chatName}`, { method: 'POST' })
					.then(response => {
						if (response.redirected) {
							alert('Диалог удален.');
							window.location.href = response.url;
						} else {
							alert('Ошибка при удалении диалога.');
						}
					});
			}
		};

		// Кнопка назад
		document.getElementById('back-button').onclick = function () {
			window.location.href = '/dashboard';
		};
	</script>
</body>

</html>